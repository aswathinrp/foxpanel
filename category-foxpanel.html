<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fox Panel | Select Category</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{ --brand:#ff7b00; }

    .upload-hint{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      color:#8a8a8a; font-weight:600; font-size:.95rem;
      background: repeating-linear-gradient(45deg,#f7f7f7 0 10px,#f3f3f3 10px 20px);
      pointer-events:none;
    }

    .choice-btn{
      min-width:160px; padding:.9rem 1.2rem; border-radius:.8rem;
      border:1px solid rgba(0,0,0,.1); background:#fff;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .choice-btn:hover{ transform:translateY(-3px); box-shadow:0 12px 24px rgba(0,0,0,.1); border-color:rgba(0,0,0,.18); }

    .editor-wrap{ padding: 2rem 0 3rem; display:none; }
    .frames-grid{ display:grid; gap:14px; grid-template-columns: repeat(5, 1fr); }
    @media (max-width: 992px){ .frames-grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 576px){ .frames-grid{ grid-template-columns: repeat(2, 1fr); } }

    .frame-card{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .canvas{ position:relative; width:100%; aspect-ratio:1/1; background:#f2f2f2; cursor:grab; overflow:hidden; }
    .canvas:active{ cursor:grabbing; }
    .img-layer{ position:absolute; left:0; top:0; width:100%; height:100%; background-position:center; background-size:cover; background-repeat:no-repeat; transform-origin:center; }
    .frame-toolbar{ padding:.6rem; display:flex; gap:.5rem; align-items:center; justify-content:space-between; }
    .size-select{ width:130px; }

    .ar-20-20 { aspect-ratio: 1/1; }
    .ar-20-30 { aspect-ratio: 2/3; }
    .ar-30-20 { aspect-ratio: 3/2; }

    .topbar{ background:#111; color:#fff; padding:.8rem 0; }
    .btn-brand{ background:var(--brand); color:#fff; border:0; }
    .btn-brand:hover{ background:#e26f00; color:#fff; }

    /* Wall Preview */
    .wall-wrap{ margin: 0 0 1.25rem; }
    .wall{
      position:relative; width:100%; aspect-ratio:16/9;
      border-radius:16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.85)),
        url('static/images/wall-bg.jpg') center/cover no-repeat;
      box-shadow: 0 25px 60px rgba(0,0,0,.12) inset, 0 10px 30px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .tile{
      position:absolute;
      left: calc(var(--x)*1%); top: calc(var(--y)*1%);
      width: calc(var(--w)*1%);
      border: 3px solid rgba(0,0,0,.6);
      border-radius:6px;
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
      background:#eee;
      cursor:pointer;
      overflow:hidden;
    }
    .tile.square    { aspect-ratio: 1/1; }
    .tile.portrait  { aspect-ratio: 2/3; }
    .tile.landscape { aspect-ratio: 3/2; }
    .tile-img{
      position:absolute; inset:0;
      background-position:center; background-size:cover; background-repeat:no-repeat;
      transform-origin:center;
    }
  </style>
</head>
<body class="bg-light">

  <header class="topbar">
    <div class="container d-flex justify-content-between align-items-center">
      <strong>Fox Panel</strong>
      <button class="btn btn-sm btn-brand" data-bs-toggle="modal" data-bs-target="#categoryModal">Select Category</button>
    </div>
  </header>

  <main class="container py-4">
    <h2 class="text-center fw-bold" style="color:var(--brand)">What do you want to add?</h2>
    <p class="text-center text-muted mb-4">Choose a category to start.</p>

    <div id="editor" class="editor-wrap">
      <!-- Wall Preview -->
      <div class="wall-wrap">
        <h5 class="fw-semibold mb-2">Preview on Wall</h5>
        <div id="wall" class="wall"></div>
      </div>

      <!-- Controls header -->
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-semibold">10+1 Combo — Upload & Fit Your Photos</h5>
        <div class="d-flex gap-2">
          <button id="downloadAll" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i> Export previews</button>
          <button id="resetAll" class="btn btn-outline-danger btn-sm"><i class="bi bi-arrow-counterclockwise"></i> Reset all</button>
          <button id="doneUpload" class="btn btn-brand btn-sm">Done</button>
        </div>
      </div>

      <div class="alert alert-info py-2">
        Tip: Click a frame or a wall tile → upload → use the zoom slider; drag the image inside the frame to position it.
      </div>

      <!-- Cards grid -->
      <div id="frames" class="frames-grid"></div>
    </div>
  </main>

  <!-- Category Modal -->
  <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">Select Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            <button class="choice-btn" id="chooseCombo">10+1 Combo</button>
            <a class="choice-btn text-decoration-none" href="single-frame.html">Single Frame</a>
            <a class="choice-btn text-decoration-none" href="offers.html">Offer</a>
          </div>
        </div>
        <div class="modal-footer border-0">
          <small class="text-muted">FoxPanel – borderless glossy panels</small>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- State ----------
    const FRAME_FILES = new Map(); // index -> File
    const FRAME_SIZES = new Map(); // index -> '20x20' | '20x30' | '30x20'

    // ---------- Wall layout (clean, even) ----------
    const WALL_LAYOUT = [
      // LEFT CLUSTER
      { i:1,  type:'portrait',  x: 8,  y:46, w: 9 },
      { i:2,  type:'square',    x:19, y:40, w:10 },
      { i:6,  type:'landscape', x:18, y:60, w:12 },

      // CENTER SPINE
      { i:3,  type:'square',    x:30, y:30, w:10 },
      { i:7,  type:'square',    x:31, y:50, w:10 },
      { i:8,  type:'landscape', x:31, y:70, w:12 },

      // RIGHT CLUSTER
      { i:4,  type:'square',    x:41, y:30, w:10 },
      { i:5,  type:'portrait',  x:44, y:50, w: 9 },
      { i:9,  type:'portrait',  x:65, y:46, w: 9 },
      { i:10, type:'square',    x:54, y:50, w:10 },
      { i:11, type:'landscape', x:44, y:76, w:12 }
    ];

    const makeEl = (t,c='') => { const e=document.createElement(t); if(c) e.className=c; return e; };

    // ---------- Build Wall ----------
    function buildWall(){
      const wall = document.getElementById('wall');
      wall.innerHTML = '';
      for (const t of WALL_LAYOUT){
        const tile = document.createElement('div');
        tile.className = `tile ${t.type}`;
        tile.style.setProperty('--x', t.x);
        tile.style.setProperty('--y', t.y);
        tile.style.setProperty('--w', t.w);
        tile.style.zIndex = String(1000 + Math.round(t.y * 10)); // lower tiles on top
        tile.dataset.idx = t.i;

        const img = document.createElement('div');
        img.className = 'tile-img';
        tile.appendChild(img);

        tile.addEventListener('click', ()=>{
          const inp = document.getElementById(`file-${t.i}`);
          if (inp) inp.click();
        });

        wall.appendChild(tile);
      }
    }

    // ---------- Build 11 cards ----------
    function buildFrames(){
      const wrap = document.getElementById('frames');
      wrap.innerHTML = '';

      for (let i=1; i<=11; i++){
        const card   = makeEl('div','frame-card');
        const canvas = makeEl('div','canvas ar-20-20');

        const hint = makeEl('div','upload-hint'); hint.textContent='Click to upload';
        const layer = makeEl('div','img-layer');
        layer.dataset.scale='1'; layer.dataset.offsetX='0'; layer.dataset.offsetY='0';
        canvas.append(hint, layer);

        const bar = makeEl('div','frame-toolbar');
        const sel = makeEl('select','form-select form-select-sm size-select');
        FRAME_SIZES.set(i, '20x20');
        sel.innerHTML = `
          <option value="20x20" selected>20×20 cm</option>
          <option value="20x30">20×30 cm</option>
          <option value="30x20">30×20 cm</option>
        `;
        const zoom = makeEl('input','form-range');
        zoom.type='range'; zoom.min='1'; zoom.max='3'; zoom.step='0.01'; zoom.value='1'; zoom.style.width='120px';

        const inputId = `file-${i}`;
        const file = makeEl('input'); file.type='file'; file.accept='image/*'; file.id=inputId; file.hidden=true;

        const btn = makeEl('button','btn btn-sm btn-outline-secondary');
        btn.type='button'; btn.innerHTML = `<i class="bi bi-upload me-1"></i> Upload`;
        btn.addEventListener('click', ()=> document.getElementById(inputId).click());

        bar.append(sel, zoom, btn, file);
        card.append(canvas, bar);
        wrap.appendChild(card);

        // Open picker by clicking empty canvas
        canvas.addEventListener('click', ()=>{
          const hasImg = layer.style.backgroundImage && layer.style.backgroundImage !== '';
          if (!hasImg) document.getElementById(inputId).click();
        });

        // Size change
        sel.addEventListener('change', ()=>{
          canvas.classList.remove('ar-20-20','ar-20-30','ar-30-20');
          if (sel.value==='20x20') canvas.classList.add('ar-20-20');
          if (sel.value==='20x30') canvas.classList.add('ar-20-30');
          if (sel.value==='30x20') canvas.classList.add('ar-30-20');
          FRAME_SIZES.set(i, sel.value);
        });

        // File load
        file.addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if(!f) return;
          const reader = new FileReader();
          reader.onload = ev=>{
            const url = `url('${ev.target.result}')`;
            layer.style.backgroundImage = url;
            hint.style.display='none';
            layer.dataset.scale='1'; zoom.value='1';
            layer.dataset.offsetX='0'; layer.dataset.offsetY='0';
            applyTransform(layer);

            FRAME_FILES.set(i, f);

            // Update wall tile preview
            const tileImg = document.querySelector(`.tile[data-idx="${i}"] .tile-img`);
            if (tileImg) tileImg.style.backgroundImage = url;
          };
          reader.readAsDataURL(f);
          e.target.value='';
        });

        // Zoom
        zoom.addEventListener('input', ()=>{
          layer.dataset.scale = zoom.value;
          applyTransform(layer);
        });

        // Drag to pan
        let drag=false, sx=0, sy=0, ox=0, oy=0;
        canvas.addEventListener('pointerdown', ev=>{
          if (!(layer.style.backgroundImage && layer.style.backgroundImage !== '')) return;
          drag=true; canvas.setPointerCapture(ev.pointerId);
          sx=ev.clientX; sy=ev.clientY;
          ox=parseFloat(layer.dataset.offsetX||'0');
          oy=parseFloat(layer.dataset.offsetY||'0');
        });
        canvas.addEventListener('pointermove', ev=>{
          if(!drag) return;
          layer.dataset.offsetX = String(ox + (ev.clientX - sx));
          layer.dataset.offsetY = String(oy + (ev.clientY - sy));
          applyTransform(layer);
        });
        ['pointerup','pointerleave','pointercancel'].forEach(evt =>
          canvas.addEventListener(evt, ()=> drag=false));
      }
    }

    function applyTransform(el){
      const s = parseFloat(el.dataset.scale||'1');
      const x = parseFloat(el.dataset.offsetX||'0');
      const y = parseFloat(el.dataset.offsetY||'0');
      el.style.transform = `translate(${x}px, ${y}px) scale(${s})`;
    }

    // ---------- Modal wiring ----------
    const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));

    document.getElementById('chooseCombo').addEventListener('click', ()=>{
      buildWall();
      buildFrames();
      document.getElementById('editor').style.display='block';
      categoryModal.hide();
      window.scrollTo({ top: document.getElementById('editor').offsetTop - 20, behavior:'smooth' });
    });

    // ---------- Reset ----------
    document.getElementById('resetAll')?.addEventListener('click', ()=>{
      document.querySelectorAll('.img-layer').forEach(l=>{
        l.style.backgroundImage=''; l.dataset.scale='1'; l.dataset.offsetX='0'; l.dataset.offsetY='0'; l.style.transform='';
        const hint = l.previousElementSibling; if(hint && hint.classList.contains('upload-hint')) hint.style.display='';
      });
      document.querySelectorAll('.tile-img').forEach(t=> t.style.backgroundImage='');
      document.querySelectorAll('.form-range').forEach(r=> r.value='1');
      FRAME_FILES.clear();
      FRAME_SIZES.clear();
    });

    // ---------- Export previews (optional) ----------
    document.getElementById('downloadAll')?.addEventListener('click', async ()=>{
      let exported = 0;
      for (let i=1; i<=11; i++){
        if (!FRAME_FILES.get(i)) continue;
        const out = await renderFrameToBlob(i);
        if (out) { downloadBlob(out); exported++; }
      }
      if (!exported) alert('Please upload at least one photo.');
    });

    // ---------- Done -> store in sessionStorage and go to cart page ----------
    function blobToDataURL(blob){
      return new Promise(res=>{
        const r = new FileReader();
        r.onload = ()=> res(r.result);
        r.readAsDataURL(blob);
      });
    }

    document.getElementById('doneUpload')?.addEventListener('click', async ()=>{
      const items = [];
      for (let i=1; i<=11; i++){
        if (!FRAME_FILES.get(i)) continue;
        const out = await renderFrameToBlob(i); // {blob, name}
        if (!out) continue;
        const dataUrl = await blobToDataURL(out.blob);
        items.push({
          idx: i,
          size: FRAME_SIZES.get(i) || '20x20',
          name: out.name,
          dataUrl
        });
      }

      if (!items.length){
        alert('Please upload at least one photo to add to the combo.');
        return;
      }

      // Save for next page
      sessionStorage.setItem('comboCart', JSON.stringify(items));
      sessionStorage.setItem('comboTotal', '100'); // fixed total for 10+1

      // Navigate to separate cart page
      location.href = 'cart-combo.html';
    });

    // ---------- Render one frame to Blob (applies zoom/pan/cover) ----------
    async function renderFrameToBlob(index){
      const card   = document.querySelectorAll('#frames .frame-card')[index-1];
      if (!card) return null;

      const canvasEl = card.querySelector('.canvas');
      const layer    = card.querySelector('.img-layer');
      const file     = FRAME_FILES.get(index);
      const sizeLbl  = FRAME_SIZES.get(index) || '20x20';
      if (!file) return null;

      const bmp = await createImageBitmap(file);

      const ar = (sizeLbl==='20x20') ? 1/1 : (sizeLbl==='20x30') ? 2/3 : 3/2;

      const base = 1400;
      const outW = (ar >= 1) ? base : Math.round(base * ar);
      const outH = (ar >= 1) ? Math.round(base / ar) : base;

      const out = document.createElement('canvas');
      out.width = outW; out.height = outH;
      const ctx = out.getContext('2d', {alpha:false});
      ctx.imageSmoothingQuality = 'high';

      const sUser = parseFloat(layer.dataset.scale || '1');
      const r = canvasEl.getBoundingClientRect();
      const sx = parseFloat(layer.dataset.offsetX || '0') * (outW / r.width);
      const sy = parseFloat(layer.dataset.offsetY || '0') * (outH / r.height);
      const coverScale = Math.max(outW / bmp.width, outH / bmp.height);

      ctx.setTransform(coverScale * sUser, 0, 0, coverScale * sUser, outW/2 + sx, outH/2 + sy);
      ctx.drawImage(bmp, -bmp.width/2, -bmp.height/2);

      return new Promise(resolve=>{
        out.toBlob(b => resolve({ blob: b, name: `frame_${String(index).padStart(2,'0')}_${sizeLbl}.jpg` }),
                   'image/jpeg', 0.92);
      });
    }

    function downloadBlob({blob, name}){
      if (!blob) return;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // Show category modal initially
    categoryModal.show();
  </script>
</body>
</html>
